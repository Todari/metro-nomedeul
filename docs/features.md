# 기능 상세 가이드

## 1. 방 생성 및 입장

### 방 생성
- **방식**: 메인 페이지에서 "방 생성하기" 버튼 클릭
- **ID 형식**: 8자리 nanoid (예: `AbC123Xy`)
- **장점**: UUID 대비 짧고 사용자 친화적, URL-safe 문자만 사용

### 방 입장 방법
1. **QR 코드 스캔**: "QR 스캔" 버튼으로 카메라를 통한 QR 코드 인식
2. **방 ID 직접 입력**: "방 ID 입력" 버튼으로 8자리 ID를 직접 입력
3. **URL 접근**: `/room/:id` 형태의 URL로 직접 접근

## 2. Tab BPM 기능

### 사용법
1. 방에 입장한 후 "Tab" 버튼을 원하는 박자에 맞춰 연속으로 클릭
2. 최소 2번 이상 탭해야 BPM 계산 시작
3. 최근 4번의 탭 간격으로 평균 BPM 계산
4. 계산된 BPM이 자동으로 메트로놈에 적용

### 특징
- **정확도**: 최근 4번 탭의 평균 간격으로 계산하여 안정적
- **범위 제한**: 40-240 BPM 범위 내로 자동 제한
- **초기화**: "초기화" 버튼으로 탭 기록 삭제 가능
- **실시간 반영**: 탭할 때마다 즉시 BPM 변경 및 동기화

## 3. 자연스러운 BPM 변경

### 기존 문제점
- BPM 변경 시 메트로놈이 처음부터 다시 시작
- 박자 위치가 리셋되어 불연속적인 느낌

### 개선된 방식
- **박자 유지**: 현재 박자 위치를 그대로 유지
- **간격 조정**: 박자 간의 시간 간격만 변경
- **서버 동기화**: 서버에서 시작 시간을 재계산하여 모든 클라이언트에 동기화

### 기술적 구현
```go
// 서버 측: BPM 변경 시 시작 시간 재계산
elapsedTime := now - state.StartTime
secondsPerBeatOld := 60.0 / float64(state.Tempo)
elapsedBeats := float64(elapsedTime) / 1000.0 / secondsPerBeatOld
secondsPerBeatNew := 60.0 / float64(tempo)
newStartTime := now - int64(elapsedBeats*secondsPerBeatNew*1000.0)
```

## 4. 사운드 미리 로딩

### 구현 방식
- **자동 로딩**: 방 입장 시 메트로놈 클래스 초기화와 동시에 사운드 로드
- **파일 경로**: `/sounds/click.mp3` (일반 박자), `/sounds/accent.mp3` (강박)
- **에러 처리**: 사운드 로드 실패 시 콘솔에 에러 로그 출력

### 장점
- **즉시 재생**: 재생 버튼 클릭 시 지연 없이 바로 소리 재생
- **사용자 경험**: 로딩 대기 시간 없이 부드러운 사용 경험

## 5. 실시간 동기화

### 동기화 메커니즘
1. **서버 시간 기준**: 서버의 `serverTime`을 기준으로 동기화
2. **오프셋 계산**: 클라이언트와 서버 간의 시간 차이 계산
3. **주기적 보정**: 3초마다 서버에서 동기화 신호 전송
4. **박자 정확도**: 밀리초 단위의 정확한 박자 동기화

### WebSocket 메시지
```json
{
  "type": "metronomeState",
  "isPlaying": true,
  "tempo": 128,
  "beats": 4,
  "startTime": 1730000000000,
  "serverTime": 1730000000000,
  "roomUuid": "AbC123Xy"
}
```

## 6. 사용자 인터페이스

### 디자인 시스템
- **다크모드**: 기본적으로 어두운 배경과 밝은 텍스트
- **Primary 색상**: 오렌지 계열 (orange.600, orange.700, orange.800)
- **Secondary 색상**: 모노톤 그레이 계열 (neutral.600, neutral.700, neutral.800)
- **카드 디자인**: 둥근 모서리, 그림자 효과, 테두리 강조

### 메인 페이지
- **방 생성**: 오렌지 "방 생성하기" 버튼
- **QR 스캔**: 그레이 "QR 스캔" 버튼
- **방 ID 입력**: 그레이 "방 ID 입력" 버튼

### 방 페이지
- **전체 레이아웃**: 전체 화면 높이 활용 (100dvh)
- **헤더**: 상단 고정 헤더 컴포넌트
- **박자 카드**: 전체 화면 중앙에 현재 박자를 시각적으로 표시
  - 기본: 어두운 배경 (neutral.800)
  - 강박 (1번째): 흰색 배경 + 오렌지 테두리
  - 일반 박자: 회색 배경 (neutral.300)
  - 전체 화면 크기로 확장 (w: full, h: full)
- **QR 표시**: 현재 주석 처리 (추후 복원 예정)
- **기본 메트로놈 컨트롤**: 
  - 현재 BPM과 박자 상태 표시
  - 시작/정지 버튼
  - 설정 버튼 (톱니바퀴 아이콘)
- **설정 바텀시트**: 설정 버튼 클릭 시 나타나는 하단 시트
  - BPM ScrollPicker (세로 스크롤)
  - 박자 HorizontalScrollPicker (가로 스크롤)
  - 탭 템포 버튼과 초기화 버튼
  - 오버레이와 닫기 버튼

### 반응형 디자인
- **모바일 최적화**: 터치 친화적인 버튼 크기
- **접근성**: 키보드 네비게이션 지원
- **시각적 피드백**: 호버/액티브 상태 표시
- **애니메이션**: 부드러운 전환 효과와 박자 깜빡임

## 7. ScrollPicker 시스템

### BPM ScrollPicker (세로)
- **범위**: 40-240 BPM, 1단위로 조정 가능
- **초기값**: 120 BPM
- **표시 개수**: 7개 (중앙 1개 + 위아래 각 3개)
- **중앙 정렬**: 선택된 값이 항상 중앙에 위치
- **자연스러운 애니메이션**: easeOutCubic 이징을 사용한 부드러운 스크롤
- **다양한 입력 방식**: 마우스 드래그, 터치 스와이프, 휠 스크롤 지원
- **실시간 동기화**: WebSocket을 통한 다중 클라이언트 동기화

### 박자 ScrollPicker (가로)
- **범위**: 2-8 박자, 1단위로 조정 가능
- **초기값**: 4 박자
- **표시 방식**: 가로 스크롤로 좌우 이동
- **전체 너비**: 부모 컨테이너의 전체 너비 활용
- **항목 배치**: Flexbox를 사용하여 겹치지 않는 자연스러운 배치
- **반응형**: 컨테이너 크기에 따라 동적으로 중앙 정렬

### 공통 사용자 경험
- **직관적 조작**: 스크롤하여 원하는 값 선택
- **시각적 피드백**: 선택된 값은 크고 굵게 표시, 거리에 따라 투명도와 크기 조절
- **터치 최적화**: 모바일에서 자연스러운 스와이프 조작
- **키보드 접근성**: 마우스 휠을 통한 정밀한 조정
- **일관된 디자인**: 동일한 스타일과 애니메이션 적용
- **다크모드 최적화**: 오렌지 계열 선택 영역, 밝은 텍스트

## 8. 박자 시각화

### BeatCard 컴포넌트
- **위치**: 방 페이지 전체 화면 중앙
- **크기**: 전체 화면 크기 (w: full, h: full)
- **레이아웃**: Flexbox 중앙 정렬로 박자 숫자 표시
- **기본 상태**: 어두운 배경 (neutral.800)에 흰색 텍스트
- **강박 표시**: 1번째 박자일 때 흰색 배경 + 오렌지 테두리
- **일반 박자**: 2번째 이후 박자일 때 회색 배경 (neutral.300)
- **애니메이션**: 200ms 동안 색상 변화 후 원래 색상으로 복귀
- **Props 변경**: totalBeats 제거, currentBeat와 isPlaying만 사용

### 박자 카운팅
- **실시간 업데이트**: BPM에 따른 정확한 간격으로 박자 카운트
- **마디 반복**: 설정된 박자 수에 도달하면 1로 리셋
- **시각적 피드백**: 각 박자마다 카드 색상 변화로 현재 위치 표시

## 9. 기술적 특징

### 프론트엔드
- **React 19**: 최신 React 기능 활용
- **Web Workers**: 안정적인 오디오 스케줄링
- **AudioContext**: 고품질 오디오 처리
- **PandaCSS**: 타입 안전한 스타일링
- **ScrollPicker 시스템**: 
  - 세로 ScrollPicker (BPM 선택)
  - 가로 HorizontalScrollPicker (박자 선택)
  - 공통 애니메이션 및 터치 지원
- **색상 시스템**: 
  - Primary: 오렌지 계열 (orange.400, orange.600, orange.700, orange.800)
  - Secondary: 중성 회색 계열 (neutral.300, neutral.600, neutral.700, neutral.800)
- **레이아웃**: 
  - 전체 화면 높이 활용 (100dvh)
  - Flexbox 기반 중앙 정렬
  - 반응형 디자인

### 백엔드
- **Go 1.22**: 고성능 서버 구현
- **WebSocket**: 실시간 양방향 통신
- **MongoDB**: 방 정보 영구 저장
- **nanoid**: 짧고 안전한 ID 생성

### 성능 최적화
- **메모리 관리**: 사용하지 않는 방 자동 정리
- **연결 관리**: WebSocket 자동 재연결
- **오디오 최적화**: Web Worker를 통한 안정적인 타이밍

## 10. 최근 변경사항 (v2.1)

### UI/UX 개선 - 컴포넌트 분리
- **MetronomeControls 분리**: 기존 단일 컴포넌트를 두 개로 분리
  - **BasicMetronomeControls**: 메인 화면 기본 컨트롤 (시작/정지, 상태 표시, 설정 버튼)
  - **SettingsBottomSheet**: 설정 전용 바텀시트 (BPM/박자 조절, 탭 템포)
- **1depth 깊은 설정**: 설정 버튼을 통한 세부 조절 기능 접근
- **깔끔한 메인 화면**: 기본 컨트롤만 표시하여 더 깔끔한 UI
- **모바일 친화적**: 바텀시트 형태로 모바일에서 사용하기 편리

### 레이아웃 개선 (v2.0)
- **전체 화면 활용**: 100dvh 높이로 전체 화면 사용
- **헤더 추가**: 상단 고정 헤더 컴포넌트 도입
- **박자 카드 확장**: 전체 화면 크기로 박자 시각화 강화
- **QR 코드 임시 제거**: 현재 주석 처리, 추후 복원 예정

### 색상 시스템 통일
- **gray → neutral**: 모든 회색 계열을 neutral로 통일
- **일관된 색상**: orange.400, neutral.300, neutral.600, neutral.700, neutral.800
- **다크모드 최적화**: 더 나은 대비와 가독성

### BeatCard 컴포넌트 개선
- **Props 단순화**: totalBeats 제거, currentBeat와 isPlaying만 사용
- **전체 화면 크기**: w: full, h: full로 확장
- **Flexbox 중앙 정렬**: 더 정확한 중앙 배치
- **색상 조정**: 일반 박자 색상을 neutral.300으로 변경

### 코드 정리
- **주석 처리**: QR 표시 관련 코드 임시 비활성화
- **Import 정리**: 사용하지 않는 컴포넌트 import 제거
- **Props 최적화**: 불필요한 props 제거로 컴포넌트 단순화
- **컴포넌트 삭제**: 기존 MetronomeControls.tsx 파일 제거
