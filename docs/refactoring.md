# 리팩토링 가이드

## 우선순위
1. 가독성/명확성 향상(네이밍/분리)
2. 결합도↓, 응집도↑
3. 에러 처리/복구 경로 강화
4. 성능/자원 사용 최적화

## 완료된 리팩토링

### v2.2 - 메트로놈 엔진 완전 재작성 (2025-9-14)
**목표**: 안정적인 메트로놈 재생을 위한 엔진 개선

**변경 사항**:
- **기존 metronome.ts 삭제**: Web Worker 기반 복잡한 구현 제거
- **새로운 metronome.ts 생성**: 
  - requestAnimationFrame 기반 간단하고 안정적인 구현
  - 중복 재생 방지 로직 강화 (`isStarting` 플래그)
  - 사용자 상호작용 후 오디오 초기화
  - 명확한 상태 관리 및 에러 처리
- **useMetronome.ts 개선**:
  - 오디오 준비 상태 관리 추가
  - 초기화 상태 표시
  - 타입 안전성 강화
- **MetronomeControls.tsx 개선**:
  - 오디오 초기화 버튼 추가
  - 초기화 상태에 따른 UI 변경
  - 로딩 애니메이션 추가

**개선 효과**:
- ✅ 첫 진입 시 재생 불가 문제 해결
- ✅ 중복 재생 문제 완전 해결
- ✅ 더 안정적인 타이밍 제공
- ✅ 사용자 경험 개선 (오디오 상태 표시)
- ✅ 코드 복잡도 대폭 감소

### v2.1 - MetronomeControls 컴포넌트 분리 (2025-9-14)
**목표**: UI 적으로 분리되어야 하는 부분을 1depth 깊게 변경

**변경 사항**:
- **MetronomeControls.tsx 삭제**: 기존 단일 컴포넌트 제거
- **MetronomeControls.tsx 생성**: 
  - 메인 화면에 표시되는 기본 컨트롤
  - 현재 BPM과 박자 상태 표시
  - 오디오 초기화 버튼
  - 시작/정지 버튼
  - 설정 버튼 (톱니바퀴 아이콘)
- **SettingsBottomSheet.tsx 생성**:
  - 설정 버튼 클릭 시 나타나는 바텀시트
  - BPM ScrollPicker (세로 스크롤)
  - 박자 HorizontalScrollPicker (가로 스크롤)
  - 탭 템포 버튼과 초기화 버튼
  - 오버레이와 닫기 버튼
- **roomPage.tsx 수정**:
  - 새로운 컴포넌트들 import
  - `isSettingsOpen` 상태 추가
  - 설정 바텀시트 열기/닫기 핸들러 추가

**개선 효과**:
- ✅ 깔끔한 메인 화면: 기본 컨트롤만 표시
- ✅ 1depth 깊은 설정: 설정 버튼을 통한 세부 조절 기능 접근
- ✅ 모바일 친화적: 바텀시트 형태로 모바일에서 사용하기 편리
- ✅ 컴포넌트 분리: 관심사 분리로 유지보수성 향상

## 권장 리팩토링 포인트
- `utils/metronome.ts`: 사운드 로드/스케줄러/WS 핸들러를 모듈화(파일 분할) 고려
- `useWebSocket`: 에러/클로즈 사유 로깅 및 지표 훅 추가
- `http` 인터셉터: 에러 표준화 포맷 도입
- 타입 강화: 서버 계약 타입 일부 `unknown` → 명시 인터페이스

## 점진적 접근
- 작은 PR 단위(≤200 라인)
- 동작 동일성 보장 → E2E/수동 체크리스트 동봉

## 성능 체크
- 모바일 저사양에서 오디오 끊김 여부
- 재연결 시 UI 블로킹 없는지
