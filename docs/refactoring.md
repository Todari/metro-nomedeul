### v3.1 - 재생 중 설정 변경 방지 (2025-01-XX)
**문제**: 재생 중 BPM/박자 변경 시 클라이언트 간 불일치 지속 발생

**조치**:
- **재생 중 설정 변경 차단**: UI 레벨에서 완전 차단
  - 재생 중에는 설정 UI 비활성화 (opacity 0.5, pointer-events: none)
  - 경고 메시지와 정지 버튼 제공
- **설정 버튼 클릭 시 자동 정지**: 사용자 경험 개선
  - 설정 버튼 클릭 시 재생 중이면 자동으로 메트로놈 정지
  - 정지 후 설정 바텀시트 열기
- **서버 측 설정 변경 시 정지**: 일관성 보장
  - `ChangeTempoWithStop`, `ChangeBeatsWithStop` 메서드 추가
  - 재생 중 설정 변경 시 자동으로 메트로놈 정지 후 변경
  - 모든 클라이언트에서 동시에 정지되어 일관성 보장

**효과**:
- 재생 중 설정 변경으로 인한 불일치 완전 제거
- 사용자 경험 개선 (명확한 안내와 자동 정지)
- 모든 클라이언트에서 일관된 상태 유지

### v3.0 - Web Audio API 도입 및 동기화 개선 (2025-01-XX)
**문제**: 오디오 파일 로딩 지연, BPM 변경 시 클라이언트 불일치, 과도한 동기화

**조치**:
- **Web Audio API 도입**: 오디오 파일 대신 실시간 사운드 생성
  - `createClickSound()` 메서드로 악센트(1200Hz)와 일반(800Hz) 비트 구분
  - 파일 로딩 불필요, 네트워크 독립적, 즉시 재생 가능
- **서버 중심 BPM 변경**: 로컬 즉시 반영 제거, 서버에서 정확한 동기화
  - 서버에서 박자 위상을 정확히 계산하여 브로드캐스트
  - 클라이언트는 서버 응답을 기다린 후 동기화
- **동기화 최적화**: 과도한 동기화 방지
  - 동기화 빈도: 1초 → 5초
  - 동기화 임계값: 50ms → 200ms
  - 안전장치: 2박자 이상의 큰 차이는 무시

**효과**:
- 파일 로딩 지연 완전 제거
- BPM 변경 시 클라이언트 간 완벽한 동기화
- 안정적인 박자 유지, 네트워크 오류 방지

### v2.4 - 위상 동기화/입력 UX 개선 (2025-09-15)
**문제**: 템포 변화 시 UI 비트가 밀림, ScrollPicker가 스냅 완료 후에만 값 변경

**조치**:
- 엔진 `setOnBeat` 콜백 추가 → UI는 엔진 비트와 직접 동기화
- `roomPage` 로컬 setInterval 카운터 제거
- ScrollPicker 이동 중에도 중앙값을 즉시 `onChange`로 반영
- 정적 자산 경로/캐시 안정화(`resolveAssetUrl`, `force-cache`)

**효과**:
- 템포 글라이드 동안에도 1-2-3-4 위상 유지
- 스크롤 조작감 향상, 지연 없이 실시간 반영
# 리팩토링 가이드

## 우선순위
1. 가독성/명확성 향상(네이밍/분리)
2. 결합도↓, 응집도↑
3. 에러 처리/복구 경로 강화
4. 성능/자원 사용 최적화

## 완료된 리팩토링

### v2.3 - 오디오 초기화/메트로놈 안정화 (2025-09-15)
**문제**: 첫 진입 재생 불가, ‘오디오 준비’가 1회에 동작하지 않음, 중복 재생, decodeAudioData 에러

**조치**:
- 메트로놈 인스턴스 선생성(WebSocket과 독립) → WebSocket은 `setWebSocket`으로 주입
- 시작 버튼에서 자동 초기화(필요 시 `initializeAudio()` → 성공 시 `start()`)
- WebSocket 리스너 중복 방지(기존 핸들러 제거 후 재바인딩)
- `decodeAudioData` 호환 래퍼/AudioContext 로컬 고정/`resume()` 보강
- Tempo Glide 도입: 템포 변경 시 루프 유지, 일정 시간 동안 자연스럽게 목표 BPM으로 수렴

**효과**:
- 첫 클릭에서 바로 초기화+재생
- 재연결/상태변경에도 중복 재생 제거
- 브라우저 호환성/안정성 향상

### v2.2 - 메트로놈 엔진 완전 재작성 (2025-9-14)
**목표**: 안정적인 메트로놈 재생을 위한 엔진 개선

**변경 사항**:
- **기존 metronome.ts 삭제**: Web Worker 기반 복잡한 구현 제거
- **새로운 metronome.ts 생성**: 
  - requestAnimationFrame 기반 간단하고 안정적인 구현
  - 중복 재생 방지 로직 강화 (`isStarting` 플래그)
  - 사용자 상호작용 후 오디오 초기화
  - 명확한 상태 관리 및 에러 처리
- **useMetronome.ts 개선**:
  - 오디오 준비 상태 관리 추가
  - 초기화 상태 표시
  - 타입 안전성 강화
- **MetronomeControls.tsx 개선**:
  - 오디오 초기화 버튼 추가
  - 초기화 상태에 따른 UI 변경
  - 로딩 애니메이션 추가

**개선 효과**:
- ✅ 첫 진입 시 재생 불가 문제 해결
- ✅ 중복 재생 문제 완전 해결
- ✅ 더 안정적인 타이밍 제공
- ✅ 사용자 경험 개선 (오디오 상태 표시)
- ✅ 코드 복잡도 대폭 감소

### v2.1 - MetronomeControls 컴포넌트 분리 (2025-9-14)
**목표**: UI 적으로 분리되어야 하는 부분을 1depth 깊게 변경

**변경 사항**:
- **MetronomeControls.tsx 삭제**: 기존 단일 컴포넌트 제거
- **MetronomeControls.tsx 생성**: 
  - 메인 화면에 표시되는 기본 컨트롤
  - 현재 BPM과 박자 상태 표시
  - 오디오 초기화 버튼
  - 시작/정지 버튼
  - 설정 버튼 (톱니바퀴 아이콘)
- **SettingsBottomSheet.tsx 생성**:
  - 설정 버튼 클릭 시 나타나는 바텀시트
  - BPM ScrollPicker (세로 스크롤)
  - 박자 HorizontalScrollPicker (가로 스크롤)
  - 탭 템포 버튼과 초기화 버튼
  - 오버레이와 닫기 버튼
- **roomPage.tsx 수정**:
  - 새로운 컴포넌트들 import
  - `isSettingsOpen` 상태 추가
  - 설정 바텀시트 열기/닫기 핸들러 추가

**개선 효과**:
- ✅ 깔끔한 메인 화면: 기본 컨트롤만 표시
- ✅ 1depth 깊은 설정: 설정 버튼을 통한 세부 조절 기능 접근
- ✅ 모바일 친화적: 바텀시트 형태로 모바일에서 사용하기 편리
- ✅ 컴포넌트 분리: 관심사 분리로 유지보수성 향상

## 권장 리팩토링 포인트
- `utils/metronome.ts`: 사운드 로드/스케줄러/WS 핸들러를 모듈화(파일 분할) 고려
- `useWebSocket`: 에러/클로즈 사유 로깅 및 지표 훅 추가
- `http` 인터셉터: 에러 표준화 포맷 도입
- 타입 강화: 서버 계약 타입 일부 `unknown` → 명시 인터페이스

## 점진적 접근
- 작은 PR 단위(≤200 라인)
- 동작 동일성 보장 → E2E/수동 체크리스트 동봉

## 성능 체크
- 모바일 저사양에서 오디오 끊김 여부
- 재연결 시 UI 블로킹 없는지
